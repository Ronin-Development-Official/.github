name: Update Releases

on:
  release:
    types: [published, unpublished]
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:

jobs:
  update-releases:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Clone Repository
        run: |
          git clone https://github.com/Ronin-Development-Official/.github.git .
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Fetch Release Info
        run: |
          TOKEN="${{ secrets.GITHUB_TOKEN }}"
          ORG="Ronin-Development-Official"
          
          # Get all repositories
          REPOS=$(curl -s -H "Authorization: token $TOKEN" \
            "https://api.github.com/orgs/$ORG/repos" | \
            jq -r '.[].name')
          
          # Initialize badges array
          BADGES=""
          
          # Loop through repositories and check for releases
          for REPO in $REPOS; do
            LATEST=$(curl -s -H "Authorization: token $TOKEN" \
              "https://api.github.com/repos/$ORG/$REPO/releases/latest" || echo "null")
            
            if [ "$LATEST" != "null" ]; then
              BADGE="[![${REPO^^}](https://img.shields.io/github/v/release/$ORG/$REPO?style=for-the-badge&logo=github&label=${REPO^^})](https://github.com/$ORG/$REPO/releases/latest)"
              BADGES="${BADGES}${BADGE}\n\n"
            fi
          done
          
          # Update README.md
          sed -i -e "/<!-- BEGIN_RELEASES -->/,/<!-- END_RELEASES -->/c\<!-- BEGIN_RELEASES -->\n${BADGES}<!-- END_RELEASES -->" README.md

      - name: Commit and Push Changes
        run: |
          if git diff --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git add README.md
          git commit -m "Update release badges"
          git push https://${{ secrets.GITHUB_TOKEN }}@github.com/Ronin-Development-Official/.github.git HEAD:main
